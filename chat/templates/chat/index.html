<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NexusAI ‚Äì Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f;
      --sidebar: #0f0f17;
      --surface: #14141e;
      --surface2: #1c1c2a;
      --border: #2a2a3d;
      --accent: #7c6af7;
      --accent2: #4fd1c5;
      --text: #e8e8f0;
      --text-muted: #6b6b8a;
      --user-bubble: #1e1e30;
      --ai-bubble: #13131c;
      --danger: #f87171;
      --sidebar-w: 260px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 20px 16px 12px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 1.3rem;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .new-chat-btn {
      margin-top: 12px;
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, var(--accent), #5b52d4);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: opacity 0.2s, transform 0.15s;
    }

    .new-chat-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .new-chat-btn:active { transform: translateY(0); }

    .sidebar-section {
      padding: 12px 12px 4px;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .conversations-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 8px;
    }

    .conversations-list::-webkit-scrollbar { width: 4px; }
    .conversations-list::-webkit-scrollbar-track { background: transparent; }
    .conversations-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .conv-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
      group: true;
    }

    .conv-item:hover { background: var(--surface2); }
    .conv-item.active { background: var(--surface2); border-left: 2px solid var(--accent); padding-left: 8px; }

    .conv-icon {
      font-size: 0.85rem;
      opacity: 0.6;
      flex-shrink: 0;
    }

    .conv-title {
      font-size: 0.82rem;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text);
    }

    .conv-actions {
      display: none;
      gap: 2px;
    }

    .conv-item:hover .conv-actions { display: flex; }

    .conv-action-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 3px 5px;
      border-radius: 4px;
      font-size: 0.8rem;
      transition: color 0.15s, background 0.15s;
    }

    .conv-action-btn:hover { color: var(--text); background: var(--border); }
    .conv-action-btn.delete:hover { color: var(--danger); }

    .sidebar-footer {
      padding: 12px;
      border-top: 1px solid var(--border);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-radius: 8px;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 0.8rem;
      color: #fff;
      flex-shrink: 0;
    }

    .user-name { font-size: 0.85rem; font-weight: 500; flex: 1; }

    .logout-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 0.75rem;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      transition: all 0.15s;
      text-decoration: none;
    }
    .logout-btn:hover { border-color: var(--danger); color: var(--danger); }

    /* ‚îÄ‚îÄ MAIN AREA ‚îÄ‚îÄ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg);
    }

    /* Top bar */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      flex-shrink: 0;
    }

    .model-select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 6px 12px;
      font-family: 'DM Mono', monospace;
      font-size: 0.8rem;
      cursor: pointer;
      outline: none;
    }

    .model-select:focus { border-color: var(--accent); }

    .chat-title {
      font-family: 'Syne', sans-serif;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-muted);
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Messages */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px 0;
    }

    .messages-container::-webkit-scrollbar { width: 6px; }
    .messages-container::-webkit-scrollbar-track { background: transparent; }
    .messages-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .message-wrapper {
      max-width: 760px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .message {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      animation: fadeUp 0.3s ease;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg-avatar {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .message.user .msg-avatar {
      background: linear-gradient(135deg, var(--accent), #5b52d4);
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      color: #fff;
    }

    .message.assistant .msg-avatar {
      background: linear-gradient(135deg, var(--accent2), #38bdf8);
      font-size: 1rem;
    }

    .msg-content {
      flex: 1;
      min-width: 0;
    }

    .msg-label {
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 5px;
    }

    .message.user .msg-label { color: #9990f5; }
    .message.assistant .msg-label { color: var(--accent2); }

    .msg-bubble {
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 0.9rem;
      line-height: 1.65;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .message.user .msg-bubble {
      background: var(--user-bubble);
      border: 1px solid #2e2e48;
    }

    .message.assistant .msg-bubble {
      background: var(--ai-bubble);
      border: 1px solid var(--border);
    }

    .msg-bubble code {
      font-family: 'DM Mono', monospace;
      background: var(--surface2);
      padding: 1px 5px;
      border-radius: 4px;
      font-size: 0.85em;
      color: var(--accent2);
    }

    .msg-bubble pre {
      background: #0d0d16;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
      overflow-x: auto;
      margin: 10px 0;
    }

    .msg-bubble pre code {
      background: none;
      padding: 0;
      color: #c9d1d9;
      font-size: 0.82rem;
    }

    /* Welcome screen */
    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }

    .welcome-logo {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 2.5rem;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 12px;
    }

    .welcome-sub {
      color: var(--text-muted);
      font-size: 1rem;
      margin-bottom: 40px;
    }

    .suggestion-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      max-width: 480px;
      width: 100%;
    }

    .suggestion-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.82rem;
      color: var(--text);
      line-height: 1.4;
    }

    .suggestion-card:hover {
      border-color: var(--accent);
      background: var(--surface2);
      transform: translateY(-2px);
    }

    .suggestion-card .s-icon { font-size: 1.2rem; margin-bottom: 6px; display: block; }
    .suggestion-card .s-title { font-weight: 600; margin-bottom: 3px; }
    .suggestion-card .s-text { color: var(--text-muted); font-size: 0.78rem; }

    /* Input area */
    .input-area {
      padding: 16px 24px 20px;
      border-top: 1px solid var(--border);
      background: var(--bg);
      flex-shrink: 0;
    }

    .input-wrapper {
      max-width: 760px;
      margin: 0 auto;
      position: relative;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      transition: border-color 0.2s;
    }

    .input-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124, 106, 247, 0.12);
    }

    #msg-input {
      width: 100%;
      background: none;
      border: none;
      outline: none;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      padding: 14px 52px 14px 16px;
      resize: none;
      max-height: 160px;
      line-height: 1.5;
    }

    #msg-input::placeholder { color: var(--text-muted); }

    .send-btn {
      position: absolute;
      right: 10px;
      bottom: 10px;
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), #5b52d4);
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s, transform 0.15s;
    }

    .send-btn:hover:not(:disabled) { opacity: 0.85; transform: scale(1.05); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .input-hint {
      max-width: 760px;
      margin: 8px auto 0;
      font-size: 0.72rem;
      color: var(--text-muted);
      text-align: center;
    }

    /* Typing indicator */
    .typing-indicator {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 4px 0;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent2);
      animation: bounce 1.2s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.7); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Rename modal */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      width: 360px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.5);
    }

    .modal h3 {
      font-family: 'Syne', sans-serif;
      font-size: 1rem;
      margin-bottom: 16px;
    }

    .modal input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.875rem;
      padding: 10px 12px;
      outline: none;
      margin-bottom: 16px;
    }

    .modal input:focus { border-color: var(--accent); }

    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }

    .btn { border-radius: 8px; padding: 8px 16px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; cursor: pointer; border: none; transition: opacity 0.2s; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
    .btn:hover { opacity: 0.85; }

    /* Empty state message */
    .no-convs {
      padding: 16px 12px;
      color: var(--text-muted);
      font-size: 0.8rem;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-header">
    <div class="logo">‚ú¶ NexusAI</div>
    <button class="new-chat-btn" onclick="startNewChat()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New Chat
    </button>
  </div>

  <div class="sidebar-section">Conversations</div>

  <div class="conversations-list" id="conv-list">
    {% if conversations %}
      {% for conv in conversations %}
      <div class="conv-item {% if active_conversation and active_conversation.id == conv.id %}active{% endif %}"
           id="conv-{{ conv.id }}"
           onclick="loadConversation({{ conv.id }})">
        <span class="conv-icon">üí¨</span>
        <span class="conv-title" id="conv-title-{{ conv.id }}">{{ conv.title }}</span>
        <div class="conv-actions">
          <button class="conv-action-btn" onclick="event.stopPropagation(); openRename({{ conv.id }}, '{{ conv.title|escapejs }}')" title="Rename">‚úèÔ∏è</button>
          <button class="conv-action-btn delete" onclick="event.stopPropagation(); deleteConversation({{ conv.id }})" title="Delete">üóëÔ∏è</button>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="no-convs">No conversations yet.<br>Start a new chat!</div>
    {% endif %}
  </div>

  <div class="sidebar-footer">
    <div class="user-info">
      <div class="avatar">{{ request.user.username|first|upper }}</div>
      <span class="user-name">{{ request.user.username }}</span>
      <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
    </div>
  </div>
</aside>

<!-- Main -->
<main class="main">
  <div class="topbar">
    <span class="chat-title" id="topbar-title">
      {% if active_conversation %}{{ active_conversation.title }}{% else %}New Conversation{% endif %}
    </span>
    <select class="model-select" id="model-select">
      <option value="gpt-4o-mini">GPT-4o Mini</option>
      <option value="gpt-4o">GPT-4o</option>
      <option value="gpt-4-turbo">GPT-4 Turbo</option>
      <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
    </select>
  </div>

  <div class="messages-container" id="messages-container">
    <div class="message-wrapper" id="messages-wrapper">
      {% if active_conversation and messages %}
        {% for msg in messages %}
        <div class="message {{ msg.role }}">
          <div class="msg-avatar">
            {% if msg.role == 'user' %}{{ request.user.username|first|upper }}{% else %}‚ú¶{% endif %}
          </div>
          <div class="msg-content">
            <div class="msg-label">{% if msg.role == 'user' %}You{% else %}NexusAI{% endif %}</div>
            <div class="msg-bubble">{{ msg.content }}</div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="welcome-screen" id="welcome-screen">
          <div class="welcome-logo">‚ú¶ NexusAI</div>
          <p class="welcome-sub">What can I help you with today?</p>
          <div class="suggestion-grid">
            <div class="suggestion-card" onclick="sendSuggestion('Explain quantum computing in simple terms')">
              <span class="s-icon">‚öõÔ∏è</span>
              <div class="s-title">Explain a concept</div>
              <div class="s-text">Quantum computing in simple terms</div>
            </div>
            <div class="suggestion-card" onclick="sendSuggestion('Write a Python function to sort a list of dictionaries by a key')">
              <span class="s-icon">üíª</span>
              <div class="s-title">Write code</div>
              <div class="s-text">Python function to sort dictionaries</div>
            </div>
            <div class="suggestion-card" onclick="sendSuggestion('Give me 5 creative startup ideas for 2025')">
              <span class="s-icon">üí°</span>
              <div class="s-title">Brainstorm ideas</div>
              <div class="s-text">Creative startup ideas for 2025</div>
            </div>
            <div class="suggestion-card" onclick="sendSuggestion('Help me write a professional email asking for a raise')">
              <span class="s-icon">‚úçÔ∏è</span>
              <div class="s-title">Write content</div>
              <div class="s-text">Professional email for a raise</div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrapper">
      <textarea id="msg-input" placeholder="Message NexusAI..." rows="1"
        onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button class="send-btn" id="send-btn" onclick="sendMessage()" title="Send">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
    <p class="input-hint">NexusAI may make mistakes. Check important info. Press Enter to send, Shift+Enter for newline.</p>
  </div>
</main>

<!-- Rename Modal -->
<div class="modal-overlay" id="rename-modal">
  <div class="modal">
    <h3>Rename Conversation</h3>
    <input type="text" id="rename-input" placeholder="Enter new title..." />
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeRename()">Cancel</button>
      <button class="btn btn-primary" onclick="submitRename()">Save</button>
    </div>
  </div>
</div>

<script>
  let currentConversationId = {% if active_conversation %}{{ active_conversation.id }}{% else %}null{% endif %};
  let isLoading = false;
  let renameTargetId = null;

  const csrfToken = '{{ csrf_token }}';

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 160) + 'px';
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  function scrollToBottom() {
    const c = document.getElementById('messages-container');
    c.scrollTop = c.scrollHeight;
  }

  function escapeHtml(text) {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  function formatContent(text) {
    // Simple code block formatting
    text = escapeHtml(text);
    text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    return text;
  }

  function appendMessage(role, content, username) {
    const wrapper = document.getElementById('messages-wrapper');
    const welcome = document.getElementById('welcome-screen');
    if (welcome) welcome.remove();

    const div = document.createElement('div');
    div.className = `message ${role}`;
    div.innerHTML = `
      <div class="msg-avatar">${role === 'user' ? username : '‚ú¶'}</div>
      <div class="msg-content">
        <div class="msg-label">${role === 'user' ? 'You' : 'NexusAI'}</div>
        <div class="msg-bubble">${formatContent(content)}</div>
      </div>`;
    wrapper.appendChild(div);
    scrollToBottom();
    return div;
  }

  function appendTyping() {
    const wrapper = document.getElementById('messages-wrapper');
    const div = document.createElement('div');
    div.className = 'message assistant';
    div.id = 'typing-msg';
    div.innerHTML = `
      <div class="msg-avatar">‚ú¶</div>
      <div class="msg-content">
        <div class="msg-label">NexusAI</div>
        <div class="msg-bubble"><div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div></div>
      </div>`;
    wrapper.appendChild(div);
    scrollToBottom();
  }

  function removeTyping() {
    const t = document.getElementById('typing-msg');
    if (t) t.remove();
  }

  async function sendMessage() {
    if (isLoading) return;
    const input = document.getElementById('msg-input');
    const content = input.value.trim();
    if (!content) return;

    const model = document.getElementById('model-select').value;
    const username = '{{ request.user.username|first|upper }}';

    input.value = '';
    input.style.height = 'auto';
    isLoading = true;
    document.getElementById('send-btn').disabled = true;

    appendMessage('user', content, username);
    appendTyping();

    try {
      const res = await fetch('/api/send/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify({ message: content, conversation_id: currentConversationId, model })
      });
      const data = await res.json();
      removeTyping();

      if (data.error) {
        appendMessage('assistant', 'Error: ' + data.error, '');
      } else {
        appendMessage('assistant', data.reply, '');
        currentConversationId = data.conversation_id;
        document.getElementById('topbar-title').textContent = data.conversation_title;
        updateSidebar(data.conversation_id, data.conversation_title);
      }
    } catch (err) {
      removeTyping();
      appendMessage('assistant', 'Network error. Please try again.', '');
    }

    isLoading = false;
    document.getElementById('send-btn').disabled = false;
    input.focus();
  }

  function updateSidebar(id, title) {
    const existing = document.getElementById('conv-' + id);
    const list = document.getElementById('conv-list');

    // Remove "no conversations" placeholder
    const noConvs = list.querySelector('.no-convs');
    if (noConvs) noConvs.remove();

    // Mark all inactive
    list.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));

    if (existing) {
      existing.classList.add('active');
      document.getElementById('conv-title-' + id).textContent = title;
      list.prepend(existing);
    } else {
      const div = document.createElement('div');
      div.className = 'conv-item active';
      div.id = 'conv-' + id;
      div.onclick = () => loadConversation(id);
      div.innerHTML = `
        <span class="conv-icon">üí¨</span>
        <span class="conv-title" id="conv-title-${id}">${title}</span>
        <div class="conv-actions">
          <button class="conv-action-btn" onclick="event.stopPropagation(); openRename(${id}, '${title.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
          <button class="conv-action-btn delete" onclick="event.stopPropagation(); deleteConversation(${id})">üóëÔ∏è</button>
        </div>`;
      list.prepend(div);
    }
  }

  async function loadConversation(id) {
    if (currentConversationId === id) return;
    currentConversationId = id;

    const res = await fetch(`/api/conversations/${id}/messages/`);
    const data = await res.json();

    const wrapper = document.getElementById('messages-wrapper');
    wrapper.innerHTML = '';

    const username = '{{ request.user.username|first|upper }}';
    data.messages.forEach(msg => appendMessage(msg.role, msg.content, username));

    document.getElementById('topbar-title').textContent = data.title;
    document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
    const item = document.getElementById('conv-' + id);
    if (item) item.classList.add('active');
    scrollToBottom();
  }

  function startNewChat() {
    currentConversationId = null;
    document.getElementById('messages-wrapper').innerHTML = `
      <div class="welcome-screen" id="welcome-screen">
        <div class="welcome-logo">‚ú¶ NexusAI</div>
        <p class="welcome-sub">What can I help you with today?</p>
        <div class="suggestion-grid">
          <div class="suggestion-card" onclick="sendSuggestion('Explain quantum computing in simple terms')">
            <span class="s-icon">‚öõÔ∏è</span>
            <div class="s-title">Explain a concept</div>
            <div class="s-text">Quantum computing in simple terms</div>
          </div>
          <div class="suggestion-card" onclick="sendSuggestion('Write a Python function to sort a list of dictionaries by a key')">
            <span class="s-icon">üíª</span>
            <div class="s-title">Write code</div>
            <div class="s-text">Python function to sort dictionaries</div>
          </div>
          <div class="suggestion-card" onclick="sendSuggestion('Give me 5 creative startup ideas for 2025')">
            <span class="s-icon">üí°</span>
            <div class="s-title">Brainstorm ideas</div>
            <div class="s-text">Creative startup ideas for 2025</div>
          </div>
          <div class="suggestion-card" onclick="sendSuggestion('Help me write a professional email asking for a raise')">
            <span class="s-icon">‚úçÔ∏è</span>
            <div class="s-title">Write content</div>
            <div class="s-text">Professional email for a raise</div>
          </div>
        </div>
      </div>`;
    document.getElementById('topbar-title').textContent = 'New Conversation';
    document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
    document.getElementById('msg-input').focus();
  }

  function sendSuggestion(text) {
    document.getElementById('msg-input').value = text;
    sendMessage();
  }

  async function deleteConversation(id) {
    if (!confirm('Delete this conversation?')) return;
    await fetch(`/api/conversations/${id}/delete/`, {
      method: 'DELETE',
      headers: { 'X-CSRFToken': csrfToken }
    });
    const item = document.getElementById('conv-' + id);
    if (item) item.remove();
    if (currentConversationId === id) startNewChat();
  }

  function openRename(id, currentTitle) {
    renameTargetId = id;
    document.getElementById('rename-input').value = currentTitle;
    document.getElementById('rename-modal').classList.add('active');
    setTimeout(() => document.getElementById('rename-input').focus(), 100);
  }

  function closeRename() {
    document.getElementById('rename-modal').classList.remove('active');
    renameTargetId = null;
  }

  async function submitRename() {
    const newTitle = document.getElementById('rename-input').value.trim();
    if (!newTitle || !renameTargetId) return;
    const res = await fetch(`/api/conversations/${renameTargetId}/rename/`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify({ title: newTitle })
    });
    const data = await res.json();
    const titleEl = document.getElementById('conv-title-' + renameTargetId);
    if (titleEl) titleEl.textContent = data.title;
    if (currentConversationId === renameTargetId)
      document.getElementById('topbar-title').textContent = data.title;
    closeRename();
  }

  document.getElementById('rename-modal').addEventListener('click', function(e) {
    if (e.target === this) closeRename();
  });

  document.getElementById('rename-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') submitRename();
    if (e.key === 'Escape') closeRename();
  });

  // Auto-focus input
  document.getElementById('msg-input').focus();
  scrollToBottom();
</script>
</body>
</html>
